name: k6 Nightly (Lean by Default)

on:
  schedule:
    - cron: '30 20 * * 6'
  workflow_dispatch:
    inputs:
      base_url:
        description: 'Optional k6 target URL override (mapped to K6_BASE_URL)'
        required: false
        default: ''
      profile:
        description: 'k6 suite profile'
        required: false
        type: choice
        default: lite
        options:
          - lite
          - gate
          - portfolio

permissions:
  contents: read

concurrency:
  group: k6-nightly
  cancel-in-progress: true

jobs:
  k6-suite:
    if: ${{ github.event_name != 'schedule' || vars.ENABLE_NIGHTLY == 'true' }}
    runs-on: ubuntu-latest
    timeout-minutes: 60
    env:
      APP_BASE_URL: ${{ vars.APP_BASE_URL || 'https://robot-store-sandbox.onrender.com' }}
      K6_BASE_URL: ${{ github.event.inputs.base_url || vars.K6_BASE_URL || '' }}
      RESET_KEY: ${{ secrets.RESET_KEY || '' }}
      PERF_USER: ${{ vars.USER_USERNAME || 'user' }}
      PERF_PASSWORD: ${{ secrets.USER_PASSWORD || vars.USER_PASSWORD || 'user123' }}
      K6_PROFILE: ${{ github.event.inputs.profile || 'lite' }}
      CI: 'true'
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: npm

      - name: Install Dependencies
        run: npm ci

      - name: Quality Gates (format, typecheck, lint)
        run: npm run ci:quality

      - name: Setup k6
        uses: grafana/setup-k6-action@v1

      - name: Run k6 performance suite
        run: node scripts/run-perf-suite.js --profile "${K6_PROFILE}"

      - name: Resolve latest k6 result folder
        id: latest
        shell: bash
        run: |
          run_id="$(tr -d '\r\n' < performance/results/latest.txt)"
          echo "run_id=${run_id}" >> "$GITHUB_OUTPUT"
          echo "Latest result directory: performance/results/${run_id}"

      - name: Upload k6 Artifacts
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: k6-${{ steps.latest.outputs.run_id }}
          path: |
            performance/results/latest.txt
            performance/results/${{ steps.latest.outputs.run_id }}
          retention-days: 7
